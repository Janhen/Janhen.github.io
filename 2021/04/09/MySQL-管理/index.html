<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MySQL-管理 | Janhen</title><meta name="keywords" content="MySQL"><meta name="author" content="Janhen"><meta name="copyright" content="Janhen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基本管理查看数据库中行数大于 0 的表 1234567891011121314151617181920-- 查找表行大于0的SELECT CONCAT(table_schema, &amp;#x27;.&amp;#x27;, table_name)                    AS  TABLE_NAME      ,engine">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL-管理">
<meta property="og:url" content="http://example.com/2021/04/09/MySQL-%E7%AE%A1%E7%90%86/index.html">
<meta property="og:site_name" content="Janhen">
<meta property="og:description" content="基本管理查看数据库中行数大于 0 的表 1234567891011121314151617181920-- 查找表行大于0的SELECT CONCAT(table_schema, &amp;#x27;.&amp;#x27;, table_name)                    AS  TABLE_NAME      ,engine">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-04-08T17:10:05.000Z">
<meta property="article:modified_time" content="2021-04-08T17:15:27.419Z">
<meta property="article:author" content="Janhen">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2021/04/09/MySQL-%E7%AE%A1%E7%90%86/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-09 01:15:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Janhen" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="http://img.janhen.com/20210331220602f7HmbN.pnghttp://img.janhen.com/20210331220602f7HmbN.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">34</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">18</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div></div></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Janhen</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySQL-管理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-04-08T17:10:05.000Z" title="Created 2021-04-09 01:10:05">2021-04-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-04-08T17:15:27.419Z" title="Updated 2021-04-09 01:15:27">2021-04-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL-管理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="基本管理"><a href="#基本管理" class="headerlink" title="基本管理"></a>基本管理</h2><p>查看数据库中行数大于 0 的表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查找表行大于0的</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(table_schema, <span class="string">&#x27;.&#x27;</span>, table_name)                    <span class="keyword">AS</span>  TABLE_NAME</span><br><span class="line">      ,<span class="keyword">engine</span>                                                   <span class="keyword">AS</span>  TABLE_ENGINE </span><br><span class="line">      ,table_type                                               <span class="keyword">AS</span>  TABLE_TYPE</span><br><span class="line">      ,table_rows                                               <span class="keyword">AS</span>  TABLE_ROWS</span><br><span class="line">      ,<span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>(data_length  / ( <span class="number">1024</span> * <span class="number">1024</span>), <span class="number">2</span>), <span class="string">&#x27;M&#x27;</span>)     <span class="keyword">AS</span>  TB_DATA_SIZE </span><br><span class="line">      ,<span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>(index_length / ( <span class="number">1024</span> * <span class="number">1024</span>), <span class="number">2</span>), <span class="string">&#x27;M&#x27;</span>)     <span class="keyword">AS</span>  TB_IDX_SIZE </span><br><span class="line">      ,<span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>((data_length + index_length ) </span><br><span class="line">            / ( <span class="number">1024</span> * <span class="number">1024</span> ), <span class="number">2</span>), <span class="string">&#x27;M&#x27;</span>)                         <span class="keyword">AS</span>  TOTAL_SIZE</span><br><span class="line">      ,<span class="keyword">CASE</span> <span class="keyword">WHEN</span>  data_length =<span class="number">0</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">ELSE</span>  <span class="keyword">ROUND</span>(index_length / data_length, <span class="number">2</span>) <span class="keyword">END</span>      <span class="keyword">AS</span>  TB_INDX_RATE</span><br><span class="line">      ,<span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>( data_free / <span class="number">1024</span> / <span class="number">1024</span>,<span class="number">2</span>), <span class="string">&#x27;MB&#x27;</span>)          <span class="keyword">AS</span>  TB_DATA_FREE </span><br><span class="line">      ,<span class="keyword">CASE</span> <span class="keyword">WHEN</span> (data_length + index_length) = <span class="number">0</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">             <span class="keyword">ELSE</span> <span class="keyword">ROUND</span>(data_free/(data_length + index_length),<span class="number">2</span>) </span><br><span class="line">       <span class="keyword">END</span>                                                        <span class="keyword">AS</span>  TB_FRAG_RATE</span><br><span class="line"><span class="keyword">FROM</span> information_schema.TABLES  </span><br><span class="line"><span class="keyword">WHERE</span> TABLE_ROWS &gt; <span class="number">0</span> </span><br><span class="line">  <span class="keyword">AND</span> table_name <span class="keyword">in</span> (<span class="string">&#x27;entitylog&#x27;</span>,<span class="string">&#x27;iterfacelog&#x27;</span>,<span class="string">&#x27;stockshiftflow&#x27;</span>,<span class="string">&#x27;stockoperlog&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> data_length </span><br><span class="line"><span class="keyword">limit</span> <span class="number">0</span>, <span class="number">20</span></span><br></pre></td></tr></table></figure>

<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><ul>
<li><code>-e</code>: 执行 SQL 语句</li>
<li><code>-D</code>: 连接的数据库</li>
<li><code>-s</code>, <code>--silent</code>: 使用 tab 作为分隔符，row ⇒ line，用于制作报表</li>
<li><code>-C</code>, <code>--compress</code>: 使用压缩在 client/server 之间</li>
<li>输出： 配合 Excel 制表<ul>
<li><code>-B</code>: 使用 Tab 替换分隔符</li>
<li><code>-N</code>: 不输出列信息</li>
<li><code>-E</code>: 垂直输出，展示格式</li>
<li><code>-H</code>: 以 HTML 输出</li>
<li><code>-X</code>: 以 XML 输出</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接 DB 执行 SQL，让结果按照特定格式显示，方便 awk, sed 处理</span></span><br><span class="line">mysql -uroot -p<span class="variable">$MYSQL_ROOT_PASSWORD</span> -h&lt;ip&gt; -D school -e <span class="string">&quot;SELECT * FROM student;&quot;</span></span><br><span class="line">mysql -udbuser -p123456 -h&lt;ip&gt; -D school -N -B -e <span class="string">&quot;SELECT * FROM student;&quot;</span></span><br><span class="line">mysql -udbuser -p123456 -h&lt;ip&gt; -D school -N -H -B -e <span class="string">&quot;SELECT * FROM student;&quot;</span> &gt; result.html</span><br></pre></td></tr></table></figure>

<h3 id="服务信息查看"><a href="#服务信息查看" class="headerlink" title="服务信息查看"></a>服务信息查看</h3><p>查看最近的 InnoDB 信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">ENGINE</span> <span class="keyword">INNODB</span> <span class="keyword">STATUS</span> \\G</span><br></pre></td></tr></table></figure>

<p>查看存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> STATUE <span class="keyword">LIKE</span> <span class="string">&#x27;.*&#x27;</span> \\G</span><br></pre></td></tr></table></figure>

<p>查看函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FUNCTION</span> STATUE <span class="keyword">LIKE</span> <span class="string">&#x27;.*&#x27;</span> \\G</span><br></pre></td></tr></table></figure>

<p>查找出所有 function,routines</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> SPECIFIC_NAME <span class="keyword">FROM</span> information_schema.Routines \\G</span><br></pre></td></tr></table></figure>

<p>查看服务器状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;%lock%&#x27;</span>\\G</span><br></pre></td></tr></table></figure>

<p>查询是否锁表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 记录当前锁表状态 </span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">OPEN</span> <span class="keyword">TABLES</span> <span class="keyword">where</span> In_use &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>查询 MySQL 进程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Top 100</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">processlist</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">processlist</span>;</span><br></pre></td></tr></table></figure>

<p>查看正在锁的事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCKS; </span><br></pre></td></tr></table></figure>

<p>查看等待锁的事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCK_WAITS; </span><br></pre></td></tr></table></figure>

<p>慢查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看慢查询时间</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&quot;long_query_time&quot;</span>;</span><br><span class="line"><span class="comment">-- 查看慢查询配置情况</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&quot;%slow_queries%&quot;</span>;</span><br><span class="line"><span class="comment">-- 查看慢查询日志路径</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&quot;%slow%&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>查看当前有那些表是打开的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">open</span> <span class="keyword">tables</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">open</span> <span class="keyword">tables</span> <span class="keyword">from</span> <span class="keyword">database</span>;</span><br></pre></td></tr></table></figure>

<p>查看服务器超时参数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> ‘%<span class="keyword">timeout</span>%’;</span><br><span class="line"><span class="comment">-- 隔离级别SHOW VARIBALES LIKE &#x27;ios%&#x27;</span></span><br><span class="line"><span class="comment">-- innodb</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_file_per_table&#x27;</span></span><br><span class="line"><span class="comment">-- 日志缓冲区</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">lIKE</span> <span class="string">&#x27;innodb_log_buffer_size&#x27;</span></span><br><span class="line"><span class="comment">-- 表的索引信息查看</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">INDEX</span> <span class="keyword">FROM</span> &lt;mytab&gt;</span><br><span class="line"><span class="comment">-- 表信息查看</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> &lt;mytab&gt; \\G</span><br><span class="line"><span class="comment">-- warning 出现后的查看</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">warnings</span>;</span><br><span class="line"><span class="comment">-- 时区设置</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">time_zone</span>=<span class="string">&#x27;+10:00&#x27;</span>;</span><br><span class="line"><span class="comment">-- 隔离级别设置</span></span><br><span class="line"><span class="keyword">SET</span> SESSSION <span class="keyword">TRANSACTION</span> <span class="keyword">LEVEL</span></span><br></pre></td></tr></table></figure>

<h3 id="用户与权限"><a href="#用户与权限" class="headerlink" title="用户与权限"></a>用户与权限</h3><p>对于连接程序的账户，不给予 <code>ALERT</code> 权限，但是给定 DML 语句的 <code>EXEC</code>，让用户通过 <code>EXEC</code> 执行函数或是存储过程来变更表结构，防止权限造成的表结构更改混乱问题</p>
<p><a target="_blank" rel="noopener" href="https://www.notion.so/1d0ad58b7c5b441e84544c888ba6b395">权限</a></p>
<p>创建检查账号:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span>,process,super,<span class="keyword">replication</span> <span class="keyword">slave</span> <span class="keyword">on</span> . </span><br><span class="line"><span class="keyword">to</span> <span class="string">&#x27;mysql_check&#x27;</span>@<span class="string">&#x27;x.x.x.x&#x27;</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">&#x27;mysql_check&#x27;</span>; </span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure>

<p><strong>如何在给定场景下为某用户授权？</strong></p>
<p>对于对接的数据库授权，主要为 DML 权限</p>
<p><strong>如何为用户授权</strong></p>
<ul>
<li>遵循最小权限原则</li>
<li>使用 Grant 命令对用户授权(非改 db)</li>
</ul>
<p><strong>用户管理流程规范</strong> 数据库用户管理流程规范 (1) 最小权限原则 (2) 密码强度策略 (3) 密码过期原则。5.7 中引入 (4) 限制历史密码重用原则</p>
<p><strong>定义账号</strong> 如何定义MySQL数据库账号？ (1) 用户名@可访问控制列表 1.%：代表可以从所有外部主机访问 2.192.168.1.%：表示可以从192.168.1网段访问 3.localhost: DB服务器本地访问 (2) 使用CREATE USER命令建立用户</p>
<p>8.0 信息更多</p>
<p><strong>如何从一个实例迁移数据库账号到另一个实例？</strong> 根据 mysql 的数据库版本是否一致判断</p>
<ul>
<li>一致，备份 mysql 数据库，目的实例进行恢复 - 不一致，到处授权 sql</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pt-show-grants u=root，p=123456，h=localhost</span><br><span class="line">show priviledges;  </span><br><span class="line">CREATE USER userinfo IDENTIFIED BY <span class="string">&#x27;3UuQuskw2k%k&#x27;</span>;</span><br><span class="line">RENAME USER userinfo TO janhen;</span><br><span class="line">DROP USER janhen;</span><br><span class="line">SHOW GRANTS FOR janhen;</span><br><span class="line"></span><br><span class="line">-- 授权给新增的用户</span><br><span class="line">GRANT SELECT,UPDATE,INSERT,DELETE ON openapi.* TO openapi;</span><br><span class="line"></span><br><span class="line">-- 取消授权</span><br><span class="line">REVOKE DELETE ON openapi.* FROM openapi;、</span><br><span class="line"></span><br><span class="line">-- 更改密码</span><br><span class="line">SET PASSWORD FOR openapi = PASSWORD(<span class="string">&#x27;!BrJ%4MROWvN&#x27;</span>);</span><br><span class="line"></span><br><span class="line">SET PASSWORD FOR <span class="string">&#x27;dbadmin&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> = bigshark;</span><br><span class="line"></span><br><span class="line">-- 设置登陆用户的密码</span><br><span class="line">SET PASSWORD = PASSWORD(<span class="string">&#x27;xxxxx&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>权限查看</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">grants</span> <span class="keyword">for</span> <span class="string">&#x27;test&#x27;</span>@<span class="string">&#x27;%&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>权限收回</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> <span class="keyword">insert</span> <span class="keyword">on</span> test.* <span class="keyword">from</span> <span class="string">&#x27;test&#x27;</span>@<span class="string">&#x27;%&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>常见权限</strong></p>
<p>(1) 管理权限</p>
<p>不提供 MySQL 的 root 权限，给管理员权限，防止误操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span></span><br><span class="line"><span class="keyword">ON</span> *.* </span><br><span class="line"><span class="keyword">TO</span> <span class="string">&#x27;janhenadmin&#x27;</span>@<span class="string">&#x27;sjfksjfaksdjfad&#x27;</span> </span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span></span><br><span class="line"><span class="keyword">grant</span> super,process,<span class="keyword">file</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">&#x27;janhen&#x27;</span>@<span class="string">&#x27;%&#x27;</span></span><br></pre></td></tr></table></figure>

<p>(2) 数据库的读写权限</p>
<p>主要用于系统对接使用， SELECT, INSERT, UPDATE, DELETE, EXECUTE</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>,<span class="keyword">INSERT</span>,<span class="keyword">UPDATE</span>,<span class="keyword">DELETE</span>,<span class="keyword">EXECUTE</span> </span><br><span class="line"><span class="keyword">ON</span> openapi.* </span><br><span class="line"><span class="keyword">TO</span> <span class="string">&#x27;openapi&#x27;</span>@<span class="string">&#x27;%&#x27;</span> </span><br><span class="line"><span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;123&#x27;</span></span><br></pre></td></tr></table></figure>

<p>(3) 监控权限</p>
<p>用于命令行监控，或是 Prometheus 进行监控信息的获取 基本的主从命令 对于统计数据库的权限</p>
<p>基本的要求： SHOW MASTER LOGS SHOW ENGINE INNODB STATUS SHOW VIEW, PROCESS, REPLICATION CLIENT, SELECT and SHOW DATABASES</p>
<p>对 mysql 表的查看</p>
<p>(4) 备份权限</p>
<p>通过 mysqldump 或是 xtracback 执行备份，需要对 VIEW、Function、event 等进行备份 SELECT, RELOAD, LOCK TABLES, REPLICATION CLIENT, SHOW VIEW, EVENT, PROCESS</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">select</span>,reload,<span class="keyword">lock</span> <span class="keyword">tables</span>,<span class="keyword">replication</span> <span class="keyword">client</span>,<span class="keyword">show</span> <span class="keyword">view</span>,<span class="keyword">event</span>,process </span><br><span class="line"><span class="keyword">ON</span> *.* </span><br><span class="line"><span class="keyword">TO</span> <span class="string">&#x27;backup&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>(5) 登陆权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">usage</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">&#x27;test&#x27;</span>@<span class="string">&#x27;%&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="MySQL-监控"><a href="#MySQL-监控" class="headerlink" title="MySQL 监控"></a>MySQL 监控</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p><strong>监控什么</strong></p>
<p>1、可用性: 端口检测，执行 select 1 或 show status 作为测试 SQL</p>
<p>2、性能监控: 并发线程监控</p>
<p>3、对主从复制进行监控</p>
<p>4、服务器资源的监控</p>
<p><strong>可用性监控</strong></p>
<p>本地 | 网络, 自带命令 ping 进行检测</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -umonitor -p -h pingtelnet ip db_port</span><br></pre></td></tr></table></figure>

<p>2、Telent 连接</p>
<p>3、程序通过网络建立数据库</p>
<p>@Q: 确定 DB 是否读写 read_only 参数，主从中注意，定期检查</p>
<p>简单查询 SELECT @@version</p>
<p>连接数量监控：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 运行最大</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;max_connections&#x27;</span>;</span><br><span class="line"><span class="comment">-- 当前连接</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;Threads_connected&#x27;</span>;</span><br><span class="line"><span class="comment">-- 比例监控</span></span><br><span class="line">Threads_connected/max_connections&gt;0.8;</span><br></pre></td></tr></table></figure>

<p><strong>性能监控</strong></p>
<p>@Q: QPS 和 TPS TPS 每秒的事务数量</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CRU QPS=(Queries2-Queries1)/(Uptime_since_flush_status2- Uptime_since_flush_status1)</span><br><span class="line"></span><br><span class="line">TPS=((Com_insert2+Com_update2+Com_delete2)- (Com_insert1+Com_update1+Com_delete1))/ (Uptime_ since_flush_status2-Uptime_since_flush_ status1)</span><br></pre></td></tr></table></figure>

<p><strong>主从复制监控</strong></p>
<p>@Q: 监控主从复制链路的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Master_Log_File:mysql-bin.001083</span><br><span class="line">Read_Master_Log_Pos:228613650</span><br><span class="line">Relay_Log_File:mysqld-relay-bin.003606</span><br><span class="line">Relay_Log_Pos:228613813</span><br><span class="line">Relay_Master_Log_File:mysql-bin.001083</span><br><span class="line">Slave_Io_Running:Yes Slave_SQL_Running:Yes Replicate_Do__DB: Replicate_Iqnore_DB:</span><br></pre></td></tr></table></figure>

<p>@Q: 主从延迟 #{。。。}</p>
<p>@Q: 验证主从复制的数据一致性</p>
<p><strong>MySQL 信息查看</strong></p>
<blockquote>
<p>不使用其他的工具，借助 MySQL 自带的命令或表进行查看</p>
</blockquote>
<p><strong>MySQL 状态信息查看</strong></p>
<p>收集这些信息可以用于检测数据库的运行情况 分为全局状态、会话状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">processlist</span>;  </span><br><span class="line"><span class="keyword">show</span> <span class="keyword">status</span>;  </span><br><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> ‘%下面变量%’;  </span><br></pre></td></tr></table></figure>

<ul>
<li>Aborted_clients 由于客户没有正确关闭连接已经死掉,已经放弃的连接数量.</li>
<li>Flush_commands 执行FLUSH命令的次数.</li>
<li>Aborted_connects 尝试已经失败的MySQL服务器的连接的次数.</li>
<li><code>Max_used_connections</code> 同时使用的连接的最大数目.</li>
<li><code>Slow_queries</code>：要花超过long_query_time时间的查询数量.</li>
<li>Open_tables 打开表的数量.</li>
<li>Open_files 打开文件的数量.</li>
<li>Open_streams 打开流的数量(主要用于日志记载）</li>
<li>Opened_tables 已经打开的表的数量.</li>
<li>Threads_connected 当前打开的连接的数量.</li>
</ul>
<p><strong>INFORMATION_SCHEMA</strong></p>
<blockquote>
<p>辅助表信息</p>
</blockquote>
<p>transaction</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> information_schema.INNODB_TRX;  </span><br></pre></td></tr></table></figure>

<p>PERFORMANCE_SCHEMA</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">&#x27;perf%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>可不与 mysql 在同一个机器上，作为额外的监控组件进行操作 支持服务器分组，支持多个 mysql 连接，较少的配置易于执行</p>
<h3 id="Innotop"><a href="#Innotop" class="headerlink" title="Innotop"></a>Innotop</h3><p>Innotop 为 MySQL和 InnoDB 事务/状态的监视器，类似 MySQL 的 top 命令，显示查询、InnoDB 事务、锁等待、死锁、打开的表、复制的状态、缓冲信息等。</p>
<p><strong>运行的参数</strong></p>
<ul>
<li>d：多久时间更新一次</li>
<li>h：连接的主机名</li>
<li>p：连接的端口</li>
<li>S：socket的位置</li>
<li>u：连接的用户</li>
<li>c: 指定配置文件运行</li>
</ul>
<p><code>#</code> 进行服务器分组<code>@</code> 进行选择连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innotop -h 127.0.0.1 \\</span><br><span class="line">  -u root -p<span class="variable">$MYSQL_ROOT_PASSWORD</span></span><br></pre></td></tr></table></figure>

<p><strong>服务器分组</strong></p>
<p>保存配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[server_groups]</span><br><span class="line"></span><br><span class="line">inner&#x3D;master233 slave158</span><br><span class="line"></span><br><span class="line">[&#x2F;server_groups] </span><br><span class="line"></span><br><span class="line">[connections]</span><br><span class="line">master233&#x3D;user&#x3D;slave have_user&#x3D;1 pass&#x3D;slave have_pass&#x3D;1 dsn&#x3D;DBI:mysql:;host&#x3D;172.17.10.233;port&#x3D;3306 savepass&#x3D;1</span><br><span class="line">slave158&#x3D;user&#x3D;slave have_user&#x3D;1 pass&#x3D;slave have_pass&#x3D;1 dsn&#x3D;DBI:mysql:;host&#x3D;172.17.10.158;port&#x3D;3306 savepass&#x3D;1</span><br><span class="line"></span><br><span class="line">[&#x2F;connections]</span><br></pre></td></tr></table></figure>

<p><strong>面板</strong></p>
<p>M: 主从情况 T: 事务情况</p>
<p>O: 打开的表 是否在使用，是否被锁住</p>
<h2 id="数据存储碎片化"><a href="#数据存储碎片化" class="headerlink" title="数据存储碎片化"></a>数据存储碎片化</h2><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><p><strong>碎片分类</strong></p>
<p>三种类型的数据碎片化</p>
<ul>
<li>行碎片（Row fragmentation）</li>
<li>行间碎片（Intra-row fragmentaion）</li>
<li>剩余空间碎片（Free space fragmentation）</li>
</ul>
<p><strong>碎片的影响</strong></p>
<p>磁盘上索引页的物理排序不接近页面上记录的索引排序，或者64页块中有许多未使用的页面被分配给索引</p>
<ul>
<li>占用的空间比“应该”占用的空间多，所有 InnoDB 数据和索引都存储在 B-trees 中，它们的 fill factor 可能在50％到100％之间变化。</li>
<li>表扫描需要比“应该”花费更多的时间。</li>
</ul>
<p><strong>碎片查看</strong></p>
<p>(1)碎片大小=数据总大小-实际表空间文件大小</p>
<p>(2)数据总大小=data_length+index_length=15220736</p>
<p>(3)实际表空间文件大小=rows<em>avg_rog_length=299335</em>50=14966750</p>
<p>(4)碎片大小=（15220736-14966750)/1024/1024=0.2M</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">table</span> <span class="keyword">status</span> <span class="keyword">from</span>  mall <span class="keyword">like</span> <span class="string">&#x27;stockshiftflow&#x27;</span> \\G;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">table</span> <span class="keyword">status</span> <span class="keyword">from</span> mall <span class="keyword">like</span> <span class="string">&#x27;stockoperlog&#x27;</span> \\G;</span><br><span class="line"><span class="comment">-- 查询空闲空间超过 50M 大小的表</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(table_schema, <span class="string">&#x27;.&#x27;</span>, table_name)                    <span class="keyword">AS</span>  TABLE_NAME</span><br><span class="line">      ,<span class="keyword">engine</span>                                                   <span class="keyword">AS</span>  TABLE_ENGINE </span><br><span class="line">      ,table_type                                               <span class="keyword">AS</span>  TABLE_TYPE</span><br><span class="line">      ,table_rows                                               <span class="keyword">AS</span>  TABLE_ROWS</span><br><span class="line">      ,<span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>(data_length  / ( <span class="number">1024</span> * <span class="number">1024</span>), <span class="number">2</span>), <span class="string">&#x27;M&#x27;</span>)     <span class="keyword">AS</span>  TB_DATA_SIZE </span><br><span class="line">      ,<span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>(index_length / ( <span class="number">1024</span> * <span class="number">1024</span>), <span class="number">2</span>), <span class="string">&#x27;M&#x27;</span>)     <span class="keyword">AS</span>  TB_IDX_SIZE </span><br><span class="line">      ,<span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>((data_length + index_length ) </span><br><span class="line">            / ( <span class="number">1024</span> * <span class="number">1024</span> ), <span class="number">2</span>), <span class="string">&#x27;M&#x27;</span>)                         <span class="keyword">AS</span>  TOTAL_SIZE</span><br><span class="line">      ,<span class="keyword">CASE</span> <span class="keyword">WHEN</span>  data_length =<span class="number">0</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">ELSE</span>  <span class="keyword">ROUND</span>(index_length / data_length, <span class="number">2</span>) <span class="keyword">END</span>      <span class="keyword">AS</span>  TB_INDX_RATE</span><br><span class="line">    ,<span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>( data_free / <span class="number">1024</span> / <span class="number">1024</span>,<span class="number">2</span>), <span class="string">&#x27;MB&#x27;</span>)            <span class="keyword">AS</span>  TB_DATA_FREE </span><br><span class="line">    ,<span class="keyword">CASE</span> <span class="keyword">WHEN</span> (data_length + index_length) = <span class="number">0</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">             <span class="keyword">ELSE</span> <span class="keyword">ROUND</span>(data_free/(data_length + index_length),<span class="number">2</span>) </span><br><span class="line">     <span class="keyword">END</span>                                                        <span class="keyword">AS</span>  TB_FRAG_RATE</span><br><span class="line"><span class="keyword">FROM</span> information_schema.TABLES  </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">ROUND</span>(DATA_FREE/<span class="number">1024</span>/<span class="number">1024</span>,<span class="number">2</span>) &gt;=<span class="number">50</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> data_free <span class="keyword">DESC</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">0</span>, <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<h3 id="碎片整理"><a href="#碎片整理" class="headerlink" title="碎片整理"></a>碎片整理</h3><p><strong>optimize table table_name</strong></p>
<p>OPTIMIZE 操作会暂时锁住表,而且数据量越大,耗费的时间也越长。</p>
<p>OPTIMIZE TABLE 后，表的变化跟存储引擎有关。</p>
<p>对于 INNODB 表,OPTIMIZE TABLE 映射到 ALTER TABLE … FORCE（或者这样翻译：在 InnoDB 表中等价 ALTER TABLE … FORCE），它重建表以更新索引统计信息并释放聚簇索引中未使用的空间。当您在InnoDB表上运行时，它会显示在 OPTIMIZE TABLE 的输出中</p>
<p>对于 <code>innodb_file_per_table=1</code> 的 InnoDB 表，OPTIMIZE TABLE 会重组表和索引的物理存储，将空闲空间释放给操作系统。也就是说 <code>OPTIMIZE TABLE [tablename]</code> 这种方式只适用于独立表空间</p>
<p><strong>ALTER TABLE table_name ENGINE = Innodb</strong></p>
<p>实际上重新整理碎片了.当执行优化操作时,实际执行的是一个空的 ALTER 命令,但是这个命令也会起到优化的作用,它会重建整个表,删掉未使用的空白空间。</p>
<p>ALTER TABLE ENGINE= INNODB,会重新整理在聚簇索引上的数据和索引。</p>
<p>在有些情况下，ALTER TABLE xxxx ENGINE= INNODB 更好。例如old_alter_table 系统变量没有启用等等。另外对于 MyISAM 类型表，使用 ALTER TABLE xxxx ENGINE= INNODB 是明显要优于 OPTIMIZE TABLE 这种方法的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> stockshiftflow <span class="keyword">ENGINE</span> = <span class="keyword">Innodb</span>;</span><br></pre></td></tr></table></figure>

<p><strong>pt-online-schema-change</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change  \\</span><br><span class="line"> --user=<span class="variable">$&#123;user&#125;</span> \\</span><br><span class="line"> --password=<span class="variable">$&#123;passwd&#125;</span> \\</span><br><span class="line"> --host=<span class="variable">$&#123;host&#125;</span>  \\</span><br><span class="line"> P=3306,D=<span class="variable">$&#123;database&#125;</span>,t=<span class="variable">$table</span> \\</span><br><span class="line"> --charset=utf8 \\</span><br><span class="line"> --alter=<span class="string">&quot;ENGINE=InnoDB&quot;</span>  \\</span><br><span class="line"> --nocheck-replication-filters \\</span><br><span class="line"> --alter-foreign-keys-method=auto  \\</span><br><span class="line"> --execute</span><br></pre></td></tr></table></figure>

<h3 id="执行脚本"><a href="#执行脚本" class="headerlink" title="执行脚本"></a>执行脚本</h3><p>文件名 clean_pieces.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#********************************************************************</span></span><br><span class="line"><span class="comment">#$1         :         清理碎片的数据库名称</span></span><br><span class="line"><span class="comment">#$2         :         清理碎片的表名称</span></span><br><span class="line"><span class="comment">#Description:         清理 MySQL 表的碎片</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">args=($*)</span><br><span class="line">database=<span class="variable">$&#123;args[0]&#125;</span></span><br><span class="line">tables=( <span class="variable">$&#123;args[@]:1&#125;</span> )</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;database: <span class="variable">$database</span>&quot;</span></span><br><span class="line"><span class="keyword">for</span> table <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;tables[@]&#125;</span>&quot;</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;table: <span class="variable">$table</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">host=<span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">user=<span class="string">&#x27;root&#x27;</span></span><br><span class="line">passwd=<span class="variable">$MYSQL_ROOT_PASSWORD</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> table <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;tables[@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">sql=<span class="string">&quot;</span></span><br><span class="line"><span class="string">select</span></span><br><span class="line"><span class="string">  CONCAT(table_schema, &#x27;.&#x27;, table_name)                           AS  TABLE_NAME,</span></span><br><span class="line"><span class="string">  concat(round(sum((DATA_LENGTH+Index_length)/1024/1024),2),&#x27;MB&#x27;) AS TABLE_SIZE,</span></span><br><span class="line"><span class="string">  concat(round(sum(DATA_LENGTH/1024/1024),2),&#x27;MB&#x27;)                AS DATA_SIZE,</span></span><br><span class="line"><span class="string">  concat(round(sum(Index_length/1024/1024),2),&#x27;MB&#x27;)               AS INDEX_SIZE,</span></span><br><span class="line"><span class="string">  table_rows                                                      AS  TABLE_ROWS,</span></span><br><span class="line"><span class="string">  CASE WHEN  data_length =0 THEN 0</span></span><br><span class="line"><span class="string">            ELSE  ROUND(index_length / data_length, 2) END        AS  TB_INDX_RATE</span></span><br><span class="line"><span class="string">from TABLES where table_schema=&#x27;<span class="variable">$database</span>&#x27; and table_name=&#x27;<span class="variable">$table</span>&#x27;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--------------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--------------- <span class="subst">$(date +%s)</span> Database: <span class="variable">$database</span>, Table: <span class="variable">$table</span>, Begin clean ... --------------- &quot;</span></span><br><span class="line">mysql -u<span class="variable">$user</span> -p<span class="variable">$passwd</span> -P3306 -h<span class="variable">$host</span> information_schema -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span><br><span class="line"></span><br><span class="line">time pt-online-schema-change  \\</span><br><span class="line">  --user=<span class="variable">$&#123;user&#125;</span> \\</span><br><span class="line">  --password=<span class="variable">$&#123;passwd&#125;</span> \\</span><br><span class="line">  --host=<span class="variable">$&#123;host&#125;</span>  \\</span><br><span class="line">  P=3306,D=<span class="variable">$&#123;database&#125;</span>,t=<span class="variable">$table</span> \\</span><br><span class="line">  --charset=utf8 \\</span><br><span class="line">  --alter=<span class="string">&quot;ENGINE=InnoDB&quot;</span>  \\</span><br><span class="line">  --nocheck-replication-filters \\</span><br><span class="line">  --alter-foreign-keys-method=auto  \\</span><br><span class="line">  --execute</span><br><span class="line"></span><br><span class="line">mysql -u<span class="variable">$user</span> -p<span class="variable">$passwd</span> -P3306 -h<span class="variable">$host</span> information_schema -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>执行 CASE</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清理 mall 数据库中表 interfacelog stockoperatelog stockshiftflow 的碎片</span></span><br><span class="line">bash clean_pieces.sh mall interfacelog stockoperatelog stockshiftflow</span><br></pre></td></tr></table></figure>

<h2 id="MySQL-配置"><a href="#MySQL-配置" class="headerlink" title="MySQL 配置"></a>MySQL 配置</h2><h3 id="服务器参数"><a href="#服务器参数" class="headerlink" title="服务器参数"></a>服务器参数</h3><p><strong>基本参数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">auto-increment-increment &#x3D; 2      </span><br><span class="line">auto-increment-offset &#x3D; 2    </span><br><span class="line">slave-skip-errors &#x3D; all </span><br></pre></td></tr></table></figure>

<p><strong>InnoDb基本参数</strong></p>
<p>状态变量</p>
<p>基本配置</p>
<p><strong>innodb_buffer_pool_size</strong></p>
<p>缓冲池并不仅仅缓存素引：它还会缓存行的数据、自适应哈希索引、插入缓冲（Insert Buffer）、锁，以及其他内部数据结构。 来帮助延迟写入，可合并多个写入操作</p>
<p><strong>innodb_log_file_size</strong></p>
<p><strong>max_connections</strong></p>
<p>最大连接数，阿里云的 MySQL5.8, 8C16G 默认为 4000</p>
<p><strong>Innodb 参数</strong></p>
<p><strong>innodb_file_per_table</strong></p>
<p>每张表都是一个独立表空间，对应每张表都是一个 <code>idb</code> 文件。</p>
<p>配置成独立表空间后可以对表进行数据、索引碎片整理。</p>
<p><strong>Innodb_flush_log_at_trx_commit</strong></p>
<p>事务刷写磁盘日志的策略</p>
<ul>
<li>0: 数据不安全，适合配置 slave 机器</li>
<li>1: 默认值，最安全的设置，每次事务后日志都会刷新到磁盘。</li>
<li>2: 每秒刷新一次事务，有丢失的风险，对于 master 有时可以接受; MySQL 进挂掉，不会丢任何事务，整个服务器挂了或断点，可能会丢失一些事务</li>
</ul>
<p>缓冲区大小</p>
<p>Innodb read io threads innodb write io threads</p>
<p>以上两个参数決定了 Innodb 读写的 I0 进程数，默认为 4</p>
<p>Innodb stats on metadata</p>
<p>决定了 MYSQL 在什么情況下会刷新 innodb 表的统计信息。</p>
<p>配置的内容：</p>
<ul>
<li>个数 - 字节 - 开启与关闭 - 百分比</li>
</ul>
<p>table_cache: 表可被缓存的数量</p>
<p>key_buffer_size:  以字节为单位</p>
<p>max_heap_table_size: 指定隐式内存临时表最大允许的大小</p>
<p>table_cache_size: 结果值比缓存中的表数小，MYSQL 将从缓存中删除不常使用的表</p>
<p>thread_cache_size:</p>
<p>query_cache_size:</p>
<p>sort_buffer_size:</p>
<p>innodb_buffer_pool_pages_dirty: 状态变量，缓冲池中的脏页数量</p>
<p>innodb_buffer_pool_instances:  5.5+ 新增</p>
<p>open_files_limit:  设置的较少，可能出现 too many open files</p>
<p><strong>参数动态配置</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> sort_buffer_size = &lt;<span class="keyword">value</span>&gt;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">GLOBAL</span> sort_buffer_size = &lt;<span class="keyword">value</span>&gt;</span><br><span class="line"><span class="keyword">SET</span> @@sort_buffer_size := &lt;<span class="keyword">value</span>&gt;</span><br><span class="line"><span class="keyword">SET</span> @@session.sort_buffer_size := &lt;<span class="keyword">value</span>&gt;</span><br><span class="line">@@global.sort_buffer_size := &lt;<span class="keyword">value</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>控制 Innodb 并发</strong></p>
<p>innodb_thread_concurrency: 并发设置，默认为 0，表示不限制 建议并发值 = CPU 数量 * 磁盘数量 * 2</p>
<p>innodb_thread_sleep_delay: 微秒为单位, 在进入内核线程超过运行的数量后，第一次休眠的时间，之后重试，若不能进入，则放入到等待队列，由 OS 处理</p>
<p>innodb_concurrency_tickets: 较少小改</p>
<p>innodb commit concurrency: 変量控制有多少个线程可以在同时间提交</p>
<p><strong>排序</strong></p>
<p>max_length_for_sort_data： 影响使用哪种排序算法</p>
<p>max_connect_errors:  网络、配置、权限等问题导致大连个链接重试，记录黑名单设置的大，有效地禁用主机黑名单</p>
<p>read_only： 建议备库设置成只读模式</p>
<p>slave_net_timeout： 默 1h，可缩短到 1min</p>
<p><strong>I/O 配置</strong></p>
<p>innodb_log_file_in_group</p>
<p><strong>主从配置</strong></p>
<p>跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断 1062: 一些主键重复 1032: 主从数据库数据不一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slave_skip_errors&#x3D;1062  </span><br></pre></td></tr></table></figure>

<p>忽略指定的数据库同步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binlog-ignore-db&#x3D;mysql</span><br></pre></td></tr></table></figure>

<p><strong>sync_binlog</strong></p>
<p>控制何时 binlog 刷新到磁盘上</p>
<p>0: 由 OS 进行控制 1: 每次事务提交的时候写入，最为安全，但影响性能</p>
<h3 id="连接参数"><a href="#连接参数" class="headerlink" title="连接参数"></a>连接参数</h3><p><strong>Connection</strong></p>
<ul>
<li>createDatabaseIfNotExist： 默认为 false</li>
<li>rollbackOnPooledClose: 默认为 true, 在 Driver 因为问题回滚..</li>
<li>useAffectedRows: 默认为 false</li>
</ul>
<p><strong>Session</strong></p>
<ul>
<li><code>characterEncoding=utf8</code>: 设置 session 对应的编码格式，告知 server 返回的结果编码格式，默认为 “autodetect”。</li>
<li>useUnicode=true： 使用 Unicode</li>
<li><code>serverTimezone=Asia/Shanghai</code>： 设置时区</li>
</ul>
<p><strong>Networking</strong></p>
<ul>
<li>connectTimeout： 默认为 0，连接超时, 单位 ms</li>
<li>socketTimeout: 默认为 0，单位 ms. 网络 socket 操作的超时时间</li>
<li>maxAllowedPacket： 默认为 65535，最大允许发送的网络包 Packet 大小</li>
<li>useCompression： 默认为 false，使用 zlib 压缩，当与服务器通信的时候</li>
</ul>
<p><strong>Statements</strong></p>
<ul>
<li>cacheDefaultTimezone： 默认为 true，缓存客户端默认时区，MySQL8.0.20 后添加的</li>
<li>queryTimeoutKillsConnection: 默认 false</li>
</ul>
<p><strong>Performance Extensions</strong></p>
<p>If ‘cacheCallableStmts’ is enabled, how many callable statements should be cached?</p>
<p>Default: 100</p>
<ul>
<li>metadataCacheSize: 结果元数据缓存的大小，在 cacheResultSetMetaData 设置为 true 时有效，默认 50</li>
<li>prepStmtCacheSize： 多少 prepared statements 被缓存，默认 25</li>
<li><code>rewriteBatchedStatements=true</code>：默认 false，重写批量的语句，提高批量的操作效率</li>
<li><code>allowMultiQueries=true</code>： 允许多查询</li>
</ul>
<h3 id="归档数据库配置"><a href="#归档数据库配置" class="headerlink" title="归档数据库配置"></a>归档数据库配置</h3><p>可定期对 MySQL 进行数据归档，可考虑使用 Archive 存储引擎，对于归档的数据库可适当减少配置，关闭一些耗时的配置。</p>
<p>配置如下：</p>
<ul>
<li>使用 4G 的 innodb 缓冲区</li>
<li>更改事务隔离级别为 READ-UNCOMMITTED，一般只是导入导出无事务操作</li>
<li>适当调整 mysqldump 的 max_allowed_packet，方便进行必要数据的恢复</li>
<li>关闭慢查询、binlog</li>
<li>减小相应的 buffer</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">port                            &#x3D; 3306</span><br><span class="line">socket                          &#x3D; &#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.sock</span><br><span class="line">pid-file                        &#x3D; &#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.pid</span><br><span class="line">datadir                         &#x3D; &#x2F;var&#x2F;lib&#x2F;mysql</span><br><span class="line">log-error                       &#x3D; &#x2F;var&#x2F;log&#x2F;mysql&#x2F;mysql-error.log</span><br><span class="line">tmpdir                          &#x3D; &#x2F;tmp</span><br><span class="line"></span><br><span class="line"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br><span class="line">symbolic-links&#x3D;0</span><br><span class="line"></span><br><span class="line"># binlog setting</span><br><span class="line">#log-bin                         &#x3D; mysql-bin</span><br><span class="line">#binlog_format                   &#x3D; MIXED      # can be mixed, decrease ..</span><br><span class="line">#binlog_format                   &#x3D; ROW      # can be mixed, decrease ..</span><br><span class="line">#binlog_row_image                &#x3D; minimal</span><br><span class="line">sync_binlog                     &#x3D; 1  # default 0    affect performance，</span><br><span class="line">                                      # safe to guarantee replication</span><br><span class="line">slave_net_timeout               &#x3D; 60 # defacult 3600</span><br><span class="line"></span><br><span class="line">#expire_logs_days                &#x3D; 7</span><br><span class="line">#relay_log                       &#x3D; mysql-relay</span><br><span class="line">#server_id                       &#x3D; &#123;&#123;server_id | default(&#39;555&#39;)&#125;&#125;</span><br><span class="line">#log_bin_trust_function_creators &#x3D; 1</span><br><span class="line">wait_timeout                    &#x3D; 57600</span><br><span class="line">interactive_timeout             &#x3D; 57600</span><br><span class="line"></span><br><span class="line">max_allowed_packet              &#x3D; 512M # or 100M</span><br><span class="line">event_scheduler                 &#x3D; 1</span><br><span class="line">max_connections                 &#x3D; 2000</span><br><span class="line"></span><br><span class="line"># log setting &#123;slow query, not using indexs&#125;</span><br><span class="line">#slow_query_log                  &#x3D; &#123;&#123;slow_query_log | default(&#39;0&#39;)&#125;&#125;</span><br><span class="line">#slow_query_log_file             &#x3D; mysql-slow.log</span><br><span class="line">#long_query_time                 &#x3D; &#123;&#123;long_query_time | default(&#39;0.20&#39;)&#125;&#125;</span><br><span class="line">#log_queries_not_using_indexes   &#x3D; &#123;&#123;log_queries_not_using_indexes | default(&#39;0&#39;)&#125;&#125;</span><br><span class="line"></span><br><span class="line"># character</span><br><span class="line">character-set-server            &#x3D; utf8mb4</span><br><span class="line"></span><br><span class="line"># tx</span><br><span class="line">transaction-isolation                   &#x3D; READ-UNCOMMITTED #REPEATABLE-READ req for ACID, SERIALIZABLE req XA</span><br><span class="line"></span><br><span class="line"># innodb</span><br><span class="line">#innodb_buffer_pool_size         &#x3D; 768M</span><br><span class="line">innodb_buffer_pool_size         &#x3D; 4G</span><br><span class="line">                                  # old 128M, 70%-80% mache mem</span><br><span class="line">innodb_log_file_size            &#x3D; 32M # old 500M, total 1G,  can bigger to 1024M</span><br><span class="line">                                       # Note: modify need to move old file to other position,may start fail</span><br><span class="line">                                       # 64G_RAM+ &#x3D; 768, 24G_RAM+ &#x3D; 512, 8G_RAM+ &#x3D; 256, 2G_RAM+ &#x3D; 128</span><br><span class="line">#innodb_log_files_in_group       &#x3D; 2 # defacult 2</span><br><span class="line">innodb_log_buffer_size          &#x3D; 64M  # defalut 8M</span><br><span class="line">innodb_buffer_pool_instances    &#x3D; 8    # default</span><br><span class="line">innodb_flush_log_at_trx_commit  &#x3D; 2 # defalut 1, per second trx flush  2&#x2F;0 &#x3D; perf, 1 &#x3D; ACID</span><br><span class="line">innodb_file_per_table           &#x3D; 1</span><br><span class="line">innodb_lock_wait_timeout        &#x3D; 60  # timeout 500</span><br><span class="line">innodb_status_output            &#x3D; ON</span><br><span class="line">innodb_status_output_locks      &#x3D; ON</span><br><span class="line">innodb_print_all_deadlocks      &#x3D; ON</span><br><span class="line">innodb_read_io_threads          &#x3D; 6  # default 4</span><br><span class="line">innodb_write_io_threads         &#x3D; 6  # default 4</span><br><span class="line">#innodb_thread_concurrency       &#x3D; 16 # default 0  recommend 2x core quantity</span><br><span class="line">#innodb_additional_mem_pool_size &#x3D; 8M #default 8M</span><br><span class="line">#innodb_open_files               &#x3D; 2000  # default 2000, can open *.idb file count</span><br><span class="line"># buffer setting</span><br><span class="line">sort_buffer_size                &#x3D; 256K # default 0.25M</span><br><span class="line">join_buffer_size                &#x3D; 256K # default 0.25M,     can bigger to 128M</span><br><span class="line">read_buffer_size                &#x3D; 512K # default 0.125M</span><br><span class="line">read_rnd_buffer_size            &#x3D; 512K # default 0.25M</span><br><span class="line">#max_length_for_sort_data        &#x3D; 1024 # default 1024</span><br><span class="line">#max_connect_errors              &#x3D; 100 # defacult 100</span><br><span class="line">#innodb_doublewrite              &#x3D; 1 # default on</span><br><span class="line">#thread_concurrency              &#x3D; 12  # default 10    recommend 2x CPU cores</span><br><span class="line">#thread_cache_size               &#x3D; 28 # defacult 28    recommend 5% of max_connections</span><br><span class="line">#open_files_limit                &#x3D; 1048576 # default 1048576</span><br><span class="line"></span><br><span class="line"># MyISAM</span><br><span class="line">#key_buffer_size                 &#x3D; 32M   # default 8M</span><br><span class="line">#query_cache_size                &#x3D; 1M # default 1M</span><br><span class="line"></span><br><span class="line"># table size</span><br><span class="line">tmp_table_size                  &#x3D; 128M  # default 16M</span><br><span class="line">max_heap_table_size             &#x3D; 128M  # default 16M recommend same size as tmp_table_size</span><br><span class="line"></span><br><span class="line"># concat</span><br><span class="line">group_concat_max_len            &#x3D; 100000000</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set           &#x3D; utf8mb4</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">default-character-set           &#x3D; utf8mb4</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">quote-names</span><br><span class="line">max_allowed_packet              &#x3D; 256M</span><br></pre></td></tr></table></figure>

<h3 id="配置案例"><a href="#配置案例" class="headerlink" title="配置案例"></a>配置案例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">port                            = 3306</span><br><span class="line">socket                          = /var/run/mysqld/mysqld.sock</span><br><span class="line">pid-file                        = /var/run/mysqld/mysqld.pid</span><br><span class="line">datadir                         = /var/lib/mysql</span><br><span class="line">log-error                       = /var/log/mysql/mysql-error.log</span><br><span class="line">tmpdir                          = /tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog setting</span></span><br><span class="line">log-bin                         = mysql-bin</span><br><span class="line"><span class="comment">#binlog_format                   = MIXED      # can be mixed, decrease ..</span></span><br><span class="line">binlog_format                   = ROW      <span class="comment"># can be mixed, decrease ..</span></span><br><span class="line">binlog_row_image                = minimal</span><br><span class="line"><span class="comment">#sync_binlog                     = 1  # default 0    affect performance，</span></span><br><span class="line">                                      <span class="comment"># safe to guarantee replication</span></span><br><span class="line">slave_net_timeout               = 60 <span class="comment"># defacult 3600</span></span><br><span class="line"></span><br><span class="line">expire_logs_days                = 7</span><br><span class="line">relay_log                       = mysql-relay</span><br><span class="line">server_id                       = 199192</span><br><span class="line">log_bin_trust_function_creators = 1</span><br><span class="line">wait_timeout                    = 57600</span><br><span class="line">interactive_timeout             = 57600</span><br><span class="line"></span><br><span class="line">max_allowed_packet              = 256M <span class="comment"># or 100M</span></span><br><span class="line">event_scheduler                 = 1</span><br><span class="line">max_connections                 = 2000</span><br><span class="line"></span><br><span class="line"><span class="comment"># log setting &#123;slow query, not using indexs&#125;</span></span><br><span class="line">slow_query_log                  = 1</span><br><span class="line">slow_query_log_file             = mysql-slow.log</span><br><span class="line">long_query_time                 = 0.20</span><br><span class="line">log_queries_not_using_indexes   = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># character</span></span><br><span class="line">character-<span class="keyword">set</span>-<span class="keyword">server</span>            = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="comment"># tx</span></span><br><span class="line"><span class="keyword">transaction</span>-<span class="keyword">isolation</span>                   = REPEATABLE-<span class="keyword">READ</span> <span class="comment">#REPEATABLE-READ req for ACID, SERIALIZABLE req XA</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># innodb</span></span><br><span class="line">innodb_buffer_pool_size         = <span class="number">18</span>G</span><br><span class="line">                                  <span class="comment"># old 128M, 70%-80% mache mem</span></span><br><span class="line">innodb_log_file_size            = <span class="number">500</span>M <span class="comment"># old 500M, total 1G,  can bigger to 1024M</span></span><br><span class="line">                                       <span class="comment"># <span class="doctag">Note:</span> modify need to move old file to other position,may start fail</span></span><br><span class="line">                                       <span class="comment"># 64G_RAM+ = 768, 24G_RAM+ = 512, 8G_RAM+ = 256, 2G_RAM+ = 128</span></span><br><span class="line"><span class="comment">#innodb_log_files_in_group       = 2 # defacult 2</span></span><br><span class="line">innodb_log_buffer_size          = <span class="number">8</span>M  <span class="comment"># defalut 8M</span></span><br><span class="line">innodb_buffer_pool_instances    = <span class="number">8</span>    <span class="comment"># default</span></span><br><span class="line">innodb_flush_log_at_trx_commit  = <span class="number">2</span> <span class="comment"># defalut 1, per second trx flush  2/0 = perf, 1 = ACID</span></span><br><span class="line">innodb_file_per_table           = <span class="number">1</span></span><br><span class="line">innodb_lock_wait_timeout        = <span class="number">60</span>  <span class="comment"># timeout 500</span></span><br><span class="line">innodb_status_output            = <span class="keyword">ON</span></span><br><span class="line">innodb_status_output_locks      = <span class="keyword">ON</span></span><br><span class="line">innodb_print_all_deadlocks      = <span class="keyword">ON</span></span><br><span class="line">innodb_read_io_threads          = <span class="number">6</span>  <span class="comment"># default 4</span></span><br><span class="line">innodb_write_io_threads         = <span class="number">6</span>  <span class="comment"># default 4</span></span><br><span class="line"><span class="comment">#innodb_thread_concurrency       = 16 # default 0  recommend 2x core quantity</span></span><br><span class="line"><span class="comment">#innodb_additional_mem_pool_size = 8M #default 8M</span></span><br><span class="line"><span class="comment">#innodb_open_files               = 2000  # default 2000, can open *.idb file count</span></span><br><span class="line"><span class="comment"># buffer setting</span></span><br><span class="line">sort_buffer_size                = <span class="number">1</span>M <span class="comment"># default 0.25M</span></span><br><span class="line">join_buffer_size                = <span class="number">1</span>M <span class="comment"># default 0.25M,     can bigger to 128M</span></span><br><span class="line">read_buffer_size                = <span class="number">1</span>M <span class="comment"># default 0.125M</span></span><br><span class="line">read_rnd_buffer_size            = <span class="number">1</span>M <span class="comment"># default 0.25M</span></span><br><span class="line"><span class="comment">#max_length_for_sort_data        = 1024 # default 1024</span></span><br><span class="line"><span class="comment">#max_connect_errors              = 100 # defacult 100</span></span><br><span class="line"><span class="comment">#innodb_doublewrite              = 1 # default on</span></span><br><span class="line"><span class="comment">#thread_concurrency              = 12  # default 10    recommend 2x CPU cores</span></span><br><span class="line"><span class="comment">#thread_cache_size               = 28 # defacult 28    recommend 5% of max_connections</span></span><br><span class="line"><span class="comment">#open_files_limit                = 1048576 # default 1048576</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MyISAM</span></span><br><span class="line"><span class="comment">#key_buffer_size                 = 32M   # default 8M</span></span><br><span class="line"><span class="comment">#query_cache_size                = 1M # default 1M</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># table size</span></span><br><span class="line">tmp_table_size                  = <span class="number">128</span>M  <span class="comment"># default 16M</span></span><br><span class="line">max_heap_table_size             = <span class="number">128</span>M  <span class="comment"># default 16M recommend same size as tmp_table_size</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># concat</span></span><br><span class="line">group_concat_max_len            = <span class="number">100000000</span></span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"><span class="keyword">default</span>-<span class="built_in">character</span>-<span class="keyword">set</span>           = utf8mb4</span><br><span class="line"></span><br><span class="line">[<span class="keyword">client</span>]</span><br><span class="line"><span class="keyword">default</span>-<span class="built_in">character</span>-<span class="keyword">set</span>           = utf8mb4</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line"><span class="keyword">quick</span></span><br><span class="line">quote-<span class="keyword">names</span></span><br><span class="line">max_allowed_packet              = <span class="number">128</span>Mr</span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="MySql-大表数据删除"><a href="#MySql-大表数据删除" class="headerlink" title="MySql 大表数据删除"></a>MySql 大表数据删除</h3><p>Mysql 官网对于大表数据的删除说明</p>
<blockquote>
<p>If you are deleting many rows from a large table, you may exceed the lock table size for an InnoDB table. To avoid this problem, or simply to minimize the time that the table remains locked, the following strategy (which does not use DELETE at all) might be helpful: Select the rows not to be deleted into an empty table that has the same structure as the original table: INSERT INTO t_copy SELECT * FROM t WHERE … ; Use RENAME TABLE to atomically move the original table out of the way and rename the copy to the original name: RENAME TABLE t TO t_old, t_copy TO t; Drop the original table:</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> copy_interfacelog </span><br><span class="line"><span class="keyword">SELECT</span> * </span><br><span class="line"><span class="keyword">FROM</span> mall.servicelog </span><br><span class="line"><span class="keyword">WHERE</span> logtime <span class="keyword">between</span> <span class="string">&#x27;2020-04-07 02:00:00&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-04-14 10:23:24&#x27;</span>;</span><br><span class="line"><span class="comment">-- 使用 mysqldump, file...备份恢复</span></span><br><span class="line"><span class="keyword">RENAME</span> <span class="keyword">TABLE</span> mall.servicelog  <span class="keyword">TO</span> mall.old_servicelog copy_interfacelog <span class="keyword">TO</span> interfacelog;  </span><br></pre></td></tr></table></figure>

<p>通过 <code>INSERT INTO &lt;table-name&gt; SELECT ..</code> 筛选出不需要删除的数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="string">`table`</span> <span class="keyword">WHERE</span> (whatever criteria) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">1000</span></span><br><span class="line">MYSQL=<span class="string">&quot;mysql -uroot -p$MYSQL_ROOT_PASSWORD &quot;</span></span><br><span class="line"><span class="keyword">sql</span>=<span class="string">&quot;select uuid from mail.interfacelog where (condition) order by uuid desc limit 1000 &quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">`seq 1 1000`</span>; </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">	$MYSQL -e <span class="string">&quot;$sql&quot;</span> | sed <span class="string">&#x27;s;/|;;g&#x27;</span> | awk <span class="string">&#x27;&#123;if(NR&gt;1)print &quot;delete from table_name where uuid = &quot;,$1,&quot;;&quot; &#125;&#x27;</span> | $MYSQL; </span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1318972/deleting-millions-of-rows-in-mysql">Deleting millions of rows in MySQL</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/optimize-table.html">MySQL :: MySQL 8.0 Reference Manual :: 13.7.3.4 OPTIMIZE TABLE Statement</a></p>
<p>官网对于 OPTIMIZE TABLE 说明</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kerrycode/p/10943122.html">潇湘隐者</a></p>
<p>MySQL 数据存储碎片化</p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/fevangelou/fb72f36bbe333e059b66">Optimized my.cnf configuration for MySQL/MariaSQL (on Ubuntu, CentOS etc. servers)</a></p>
<p>优化的 mysql 配置</p>
<p><a target="_blank" rel="noopener" href="https://www.percona.com/blog/2014/01/28/10-mysql-performance-tuning-settings-after-installation/">Ten MySQL performance tuning settings after installation</a></p>
<p>percona 网站对于 MySQL 性能调整配置说明</p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-reference-configuration-properties.html">https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-reference-configuration-properties.html</a></p>
<p>官网对于属性的配置</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/32286518/whats-the-difference-between-cacheprepstmts-and-useserverprepstmts-in-mysql-jdb">What’s the difference between cachePrepStmts and useServerPrepStmts in MySQL JDBC Driver</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2993251/jdbc-batch-insert-performance">https://stackoverflow.com/questions/2993251/jdbc-batch-insert-performance</a></p>
<p>批量操作参数的更改</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Janhen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2021/04/09/MySQL-%E7%AE%A1%E7%90%86/">http://example.com/2021/04/09/MySQL-%E7%AE%A1%E7%90%86/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/04/09/Flume-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Flume-数据采集</div></div></a></div><div class="next-post pull-right"><a href="/2021/04/09/MySQL-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">MySQL-备份与恢复</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/04/09/MySQL-事务/" title="MySQL 事务"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-09</div><div class="title">MySQL 事务</div></div></a></div><div><a href="/2021/04/09/MySQL-备份与恢复/" title="MySQL-备份与恢复"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-09</div><div class="title">MySQL-备份与恢复</div></div></a></div><div><a href="/2021/04/09/MySQL-结构索引与SQL优化/" title="MySQL-结构索引与SQL优化"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-09</div><div class="title">MySQL-结构索引与SQL优化</div></div></a></div><div><a href="/2021/04/09/MySql-索引/" title="MySql-索引"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-09</div><div class="title">MySql-索引</div></div></a></div><div><a href="/2021/04/09/Mysql-日志/" title="Mysql-日志"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-09</div><div class="title">Mysql-日志</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="http://img.janhen.com/20210331220602f7HmbN.pnghttp://img.janhen.com/20210331220602f7HmbN.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Janhen</div><div class="author-info__description">大数据、后端、运维分享</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">34</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">18</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Janhen"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%AE%A1%E7%90%86"><span class="toc-text">基本管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-text">命令执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E4%BF%A1%E6%81%AF%E6%9F%A5%E7%9C%8B"><span class="toc-text">服务信息查看</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%B8%8E%E6%9D%83%E9%99%90"><span class="toc-text">用户与权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL-%E7%9B%91%E6%8E%A7"><span class="toc-text">MySQL 监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Innotop"><span class="toc-text">Innotop</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%A2%8E%E7%89%87%E5%8C%96"><span class="toc-text">数据存储碎片化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A2%8E%E7%89%87%E6%95%B4%E7%90%86"><span class="toc-text">碎片整理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC"><span class="toc-text">执行脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL-%E9%85%8D%E7%BD%AE"><span class="toc-text">MySQL 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%82%E6%95%B0"><span class="toc-text">服务器参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%8F%82%E6%95%B0"><span class="toc-text">连接参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%92%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-text">归档数据库配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%A1%88%E4%BE%8B"><span class="toc-text">配置案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySql-%E5%A4%A7%E8%A1%A8%E6%95%B0%E6%8D%AE%E5%88%A0%E9%99%A4"><span class="toc-text">MySql 大表数据删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ref"><span class="toc-text">Ref</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/04/14/Spark-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96/" title="Spark-内存管理与持久化"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spark-内存管理与持久化"/></a><div class="content"><a class="title" href="/2021/04/14/Spark-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96/" title="Spark-内存管理与持久化">Spark-内存管理与持久化</a><time datetime="2021-04-14T07:10:07.000Z" title="Created 2021-04-14 15:10:07">2021-04-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/14/Spark-%E7%AE%A1%E7%90%86/" title="Spark-管理"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spark-管理"/></a><div class="content"><a class="title" href="/2021/04/14/Spark-%E7%AE%A1%E7%90%86/" title="Spark-管理">Spark-管理</a><time datetime="2021-04-14T05:52:17.000Z" title="Created 2021-04-14 13:52:17">2021-04-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/14/Spark-%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6%E5%92%8C%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C/" title="Spark-运行机制和作业执行"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spark-运行机制和作业执行"/></a><div class="content"><a class="title" href="/2021/04/14/Spark-%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6%E5%92%8C%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C/" title="Spark-运行机制和作业执行">Spark-运行机制和作业执行</a><time datetime="2021-04-14T05:52:17.000Z" title="Created 2021-04-14 13:52:17">2021-04-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/09/Flume-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/" title="Flume-数据采集"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flume-数据采集"/></a><div class="content"><a class="title" href="/2021/04/09/Flume-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/" title="Flume-数据采集">Flume-数据采集</a><time datetime="2021-04-09T08:56:07.000Z" title="Created 2021-04-09 16:56:07">2021-04-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/09/MySQL-%E7%AE%A1%E7%90%86/" title="MySQL-管理"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL-管理"/></a><div class="content"><a class="title" href="/2021/04/09/MySQL-%E7%AE%A1%E7%90%86/" title="MySQL-管理">MySQL-管理</a><time datetime="2021-04-08T17:10:05.000Z" title="Created 2021-04-09 01:10:05">2021-04-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Janhen</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>